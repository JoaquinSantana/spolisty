<script>

var ready;
ready = function() {

  $('#genrechart').highcharts({
      chart: {
          type: 'column'
      },
      title: {
          text: ' '
      },
      xAxis: {
          type: 'category'
      },

      legend: {
        enabled: false
      },
      plotOptions: {
          series: {
              groupPadding: 0,
              borderWidth: 0,
              dataLabels: {
                  enabled: true
              }
          }
      },
      series: [{ 
          name: 'Total track',
          colorByPoint: true,
          data: <%= raw @user.sorted_tracks %>
      }],
      labels: {
        style: {
          color: '#111111'
        }
      }
  });

};

$(document).ready(ready);
$(document).on('page:load', ready);


  
</script>

<section class="user_profile">
  <div class="row">
    <%= render partial: 'shared/user_heading', locals: { user: @user } %>

    <div class="genre-profile col-md-8 col-md-offset-2 text-center">
    
    <% if current_user.sign_in_count == 1 && @user.playlists.blank?  && current_page?(user_path(current_user)) %>
      <p class="welcome">
        Welcome to the Spolisty App.
      </p>
      <p class="welcome_body">
         I want invide you to download your playlists from spotify account. 
      </p>
    <% end %>


      <% if current_user == @user && @user.playlists.blank? %>
        <div class="row">
          <div class="col-md-4 col-md-offset-4">
            <%= link_to "Import your playlists from spotify", 
                import_user_playlists_path(current_user), 
                class: 'btn btn-primary btn-block btn-lg' 
            %>
          </div>
        </div>
      <% else %>

        <div class="clearfix visible-sm-block visible-xs-block"></div>

        <%= render partial: 'shared/user_navbar', locals: { user: @user } %>


        <% if current_user.charts.empty? && current_page?(user_path(current_user)) %>

          <p class="welcome">
            The Last Step
          </p>
          <p class="welcome_body">
             Generate your chart based on your playlists. 
          </p>
          <div class="row">
            <div class="col-md-4 col-md-offset-4">
              <%= link_to "Generate Music Chart", user_charts_path([current_user, current_user.charts.build]), method: :post, 
                class: 'btn btn-primary btn-block btn-lg' %>
            </div>
          </div>
        <% elsif current_user.tracks.includes(:genre).map(&:genre).any?{|n| n.nil?} && current_user?(@user) %>

          <h3 class="lead">Sorry, We cant classified any of your tracks.</h3>

        <% else %>
          <h3 class="musicchart_heading"><%= @user.nick %> music chart</h3>
          <div id="genrechart" style="width:100%; height:400px;"></div>
        <% end %>
      <% end %>
       <% if current_user?(@user) %>
        <div class="unclassify tracks">
          <h2>Your classified tracks</h2>

          <table class="table">
            <thead>
              <tr>w
                <th>Track name</th>
                <th>Category</th>
                <th>spotify Category</th>
              </tr>
            </thead>

            <tbody>
              <% current_user.tracks.includes(:genre).select{|tr| !tr.genre.nil? }.each do |tr| %>
                <tr>
                  <td><%= tr.name %></td>
                  <td><%= tr.genre.name %></td>
                  <td><%= tr.spotify_genre %></td>
                </tr>
              <% end %>
            </tbody>
          </table>              

          <h2>Your tracks without genre</h2>

          <table class="table">
            <thead>
              <tr>w
                <th>Track name</th>
                <th>Category</th>
                <th>spotify category</th>
              </tr>
            </thead>

            <tbody>
              <% current_user.tracks.select{|tr| tr.genre.nil? }.each do |tr| %>
                <tr>
                  <td><%= tr.name %></td>
                  <td>Brak kategorii</td>
                  <td><%= tr.try(:spotify_genre) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>

        </div><!-- /unclassify tracks -->
      <% end %><!-- /if current_user?(@user) -->

        <div class="filer-tracks">
          <ul id="portfolio-filter" class="nav nav-pills nav-justified">
            <% @user.genres.uniq.each do |genre| %>
              <li><a href="#<%= genre.name %>"><%= genre.name %></a></li>
            <% end %>
          </ul>

          <ul id="portfolio-list" class="row">
            <% @tracks.each do |tr| %>
              <li class="<%= tr.genre.name %> col-md-12">
                <div class="track_name pull-left">
                  <%= truncate(tr.name, length: 25) %>
                  
                </div>
                <div class="track_info pull-left">
                  <%= tr.try(:artist).try(:name) %>
                  <%= tr.try(:album).try(:name) %>
                </div>
                <div class="track_duration pull-right">
                  <%= link_to [@user, tr.playlist, track: tr], "data-toggle" => "tooltip", "data-placement" => "top", "title" => "Listen this track on his playlist" do %>
                    <i class="fa fa-play">  </i>    
                  <% end %>
                  <%= tr.try(:track_duration) %>
                </div>
              </li>
            <% end %>
          </ul>      
      </div>

</section>
